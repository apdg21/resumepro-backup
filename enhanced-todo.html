<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced To-Do & Notes</title>
    <meta name="theme-color" content="#6200ea">
    <meta name="description" content="A to-do list and notes app with labels, dates, reminders, and calendar view.">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png">
    <style>
        :root {
            --primary-color: #6200ea;
            --primary-dark: #3700b3;
            --secondary-color: #03dac6;
            --error-color: #b00020;
            --surface-color: #ffffff;
            --background-color: #f5f7f9;
            --on-primary: #ffffff;
            --on-surface: #000000;
            --on-error: #ffffff;
            --border-color: #e0e0e0;
            --text-secondary: #5f6368;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: #333;
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .app-description {
            color: var(--text-secondary);
            margin: 8px 0 0;
            font-size: 16px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(98, 0, 234, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-delete {
            background-color: var(--error-color);
        }
        
        .btn-delete:hover {
            background-color: #8a0c2a;
        }
        
        .btn-reminder {
            background-color: #ff9800;
        }
        
        .btn-reminder:hover {
            background-color: #f57c00;
        }
        
        .btn-filter {
            background-color: #4caf50;
        }
        
        .btn-filter:hover {
            background-color: #3d8b40;
        }
        
        .items-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        .item:last-child {
            border-bottom: none;
        }
        
        .item-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .item-text {
            flex: 1;
            margin-right: 15px;
        }
        
        .item-title {
            font-weight: 500;
            margin: 0 0 5px;
        }
        
        .item-details {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .item-action-btn {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
        }
        
        .reminder-badge {
            background-color: #ff9800;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 500;
        }
        
        .reminder-form {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .reminder-form input {
            flex: 1;
        }
        
        .reminder-form button {
            width: auto;
        }
        
        .reminder-item {
            background-color: #fff8e1;
            border-left: 3px solid #ff9800;
        }
        
        .calendar-item {
            background-color: #e8f5e9;
            border-left: 3px solid #4caf50;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s;
            max-width: 350px;
        }
        
        .notification.error {
            background-color: var(--error-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9aa0a6;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 15px;
        }
        
        .calendar-container {
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .explanation-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .explanation-box h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        
        /* Modal styles for reminder setting */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .reminder-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .reminder-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reminder-option:hover {
            border-color: var(--primary-color);
            background-color: #f5f0ff;
        }
        
        .reminder-option.selected {
            border-color: var(--primary-color);
            background-color: #f0e6ff;
        }
        
        .reminder-option i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .custom-reminder {
            margin-top: 20px;
        }
        
        .custom-reminder.hidden {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Material Icons */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            vertical-align: middle;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-range-info {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div id="login" style="display: block;">
    <!-- Login section copied from "enhanced todo with login.html" -->
    <div class="login-container">
        <div class="app-header">
            <h1>Enhanced To-Do & Notes</h1>
            <p>Organize your tasks and notes with reminders and calendar view</p>
        </div>

        <h2>Login to Your Account</h2>

        <button onclick="googleLogin()">Google</button>
        <button onclick="fbLogin()">Facebook</button>

        <p>or</p>

        <form>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <input type="password" id="confirmPassword" placeholder="Confirm Password">
        </form>

        <div>
            <input type="checkbox" id="remember">
            <label for="remember">Remember me</label>
            <a href="#">Forgot password?</a>
        </div>

        <button onclick="customLogin()">Login</button> <!-- Renamed to customLogin to avoid conflict -->

        <p>Need to create an account?</p>

        <div class="demo-accounts">
            <p>Demo Accounts (for testing):</p>
            <p>user1@example.com password1</p>
            <p>user2@example.com password2</p>
        </div>
    </div>
</div>

<div id="main-app" style="display: none;">
    <!-- Main app content from "enhanced todo.html" (latest update), with added IDs for JS access -->
    <dialog id="reminderModal">
        <h2>Set Reminder</h2>
        <button onclick="closeReminderModal()">Ã—</button>

        <button onclick="setPreset('later')">schedule Later Today - Today, 6:00 PM</button>
        <button onclick="setPreset('tomorrow')">wb_sunny Tomorrow - Tomorrow, 9:00 AM</button>
        <button onclick="setPreset('nextWeek')">event Next Week - Next Monday, 9:00 AM</button>
        <button onclick="setPreset('custom')">edit_calendar Custom - Select date & time</button>

        <div id="custom-date-time" style="display: none;">
            <label>Date: <input type="date" id="custom-date"></label>
            <label>Time: <input type="time" id="custom-time"></label>
        </div>

        <button onclick="confirmReminder()">notifications Set Reminder</button>
    </dialog>

    <header>
        <h1>Enhanced To-Do & Notes</h1>
        <p>Organize your tasks and notes with reminders and calendar view</p>
        <span id="user-email"></span>
        <button onclick="logout()">Logout</button>
    </header>

    <nav>
        <a href="#tasks">Tasks</a>
        <a href="#notes">Notes</a>
        <a href="#reminders">Reminders</a>
        <a href="#calendar">Calendar</a>
    </nav>

    <section id="tasks">
        <h2>checklist Add New Task</h2>
        <input id="task-title" placeholder="">
        <select id="task-status">
            <option>To Do</option>
            <option>In Process</option>
            <option>Finished</option>
        </select>
        <button id="set-task-reminder" onclick="showReminderModal('task')">notifications Set Reminder</button>
        <button id="add-task-btn" onclick="addTask()">add Add Task</button>

        <h2>format_list_bulleted My Tasks</h2>
        <div id="my-tasks"></div>
    </section>

    <section id="notes">
        <h2>note_add Add New Note</h2>
        <input id="note-title" placeholder="">
        <input id="note-content" placeholder="">
        <button id="set-note-reminder" onclick="showReminderModal('note')">notifications Set Reminder</button>
        <button id="add-note-btn" onclick="addNote()">add Add Note</button>

        <h2>notes My Notes</h2>
        <div id="my-notes"></div>
    </section>

    <section id="reminders">
        <p>info How Reminders Work</p>
        <p>Reminders are set for specific tasks or notes and will trigger a notification at the scheduled time. The notification will appear even if the app is closed (as long as the browser is running).</p>
        <p>To delete a reminder, click the delete button next to it in the list below. You can also edit reminders directly from tasks or notes.</p>

        <h2>notifications Upcoming Reminders</h2>
        <div id="upcoming-reminders"></div>
    </section>

    <section id="calendar">
        <h2>calendar_today View by Date</h2>
        <label>From Date: <input type="date" id="from-date"></label>
        <label>To Date: <input type="date" id="to-date"></label>
        <button id="filter-btn" onclick="filterCalendar()">filter_list Filter by Date Range</button>
        <p>Showing items from <span id="from-span"></span> to <span id="to-span"></span></p>
        <div id="calendar-list"></div>
    </section>

    <aside>
        <section>
            <h2>today Today's Overview</h2>
            <div id="today-overview">Loading your daily overview...</div>
        </section>

        <section>
            <h2>insights Quick Stats</h2>
            <div id="quick-stats">Your statistics will appear here</div>
        </section>

        <section>
            <h2>event Quick Date Filter</h2>
            <input type="date" id="quick-date">
            <button onclick="quickView()">search View Items</button>
        </section>
    </aside>
</div>

<!-- Scripts -->
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
    // Initialize Facebook SDK
    window.fbAsyncInit = function() {
        FB.init({
            appId: 'YOUR_FB_APP_ID',
            cookie: true,
            xfbml: true,
            version: 'v18.0'
        });
        FB.AppEvents.logPageView();
    };

    let currentUser = null;
    let tasks = [];
    let notes = [];
    let currentType = ''; // 'task' or 'note'
    let currentEditId = null;
    let currentReminderDate = '';
    let currentReminderTime = '';

    function showMain() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-email').innerText = currentUser;
    }

    function logout() {
        currentUser = null;
        // Optional sign out for social
        if (gapi.auth2) gapi.auth2.getAuthInstance().signOut();
        FB.logout();
        document.getElementById('login').style.display = 'block';
        document.getElementById('main-app').style.display = 'none';
    }

    function googleLogin() {
        gapi.load('auth2', function() {
            gapi.auth2.init({client_id: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'});
            gapi.auth2.getAuthInstance().signIn().then(function(googleUser) {
                let profile = googleUser.getBasicProfile();
                let email = profile.getEmail();
                google.script.run.withSuccessHandler(function(res) {
                    if (res === 'ok') {
                        currentUser = email;
                        showMain();
                        loadData();
                    }
                }).checkOrCreateUser(email);
            });
        });
    }

    function fbLogin() {
        FB.login(function(response) {
            if (response.authResponse) {
                FB.api('/me?fields=email', function(res) {
                    let email = res.email;
                    if (email) {
                        google.script.run.withSuccessHandler(function(r) {
                            if (r === 'ok') {
                                currentUser = email;
                                showMain();
                                loadData();
                            }
                        }).checkOrCreateUser(email);
                    } else {
                        alert('Could not get email from Facebook');
                    }
                });
            } else {
                alert('Facebook login failed');
            }
        }, {scope: 'email'});
    }

    function customLogin() {
        let email = document.getElementById('email').value;
        let pass = document.getElementById('password').value;
        let confirm = document.getElementById('confirmPassword').value;

        if (confirm) {
            if (pass !== confirm) {
                alert('Passwords do not match');
                return;
            }
            google.script.run.withSuccessHandler(function(res) {
                if (res === 'ok') {
                    currentUser = email;
                    showMain();
                    loadData();
                } else if (res === 'exists') {
                    alert('User already exists');
                } else {
                    alert('Registration failed');
                }
            }).register(email, pass);
        } else {
            google.script.run.withSuccessHandler(function(res) {
                if (res === 'ok') {
                    currentUser = email;
                    showMain();
                    loadData();
                } else {
                    alert('Invalid credentials');
                }
            }).login(email, pass);
        }
    }

    function loadData() {
        google.script.run.withSuccessHandler(function(data) {
            tasks = data;
            renderTasks();
        }).getTasks(currentUser);

        google.script.run.withSuccessHandler(function(data) {
            notes = data;
            renderNotes();
        }).getNotes(currentUser);

        updateReminders();
        filterCalendar(); // Initial load
        updateToday();
        updateStats();
        setupNotifications();
    }

    function renderTasks() {
        let container = document.getElementById('my-tasks');
        container.innerHTML = '';
        if (tasks.length === 0) {
            container.innerHTML = '<p>check_box No tasks yet. Add a task to get started!</p>';
            return;
        }
        tasks.forEach(task => {
            let div = document.createElement('div');
            div.innerHTML = `
                <input type="checkbox" ${task.status === 'Finished' ? 'checked' : ''} disabled>
                ${task.title} - ${task.status}
                ${task.reminderDate ? `Reminder: ${task.reminderDate} ${task.reminderTime}` : ''}
                <button onclick="editItem('task', ${task.id})">Edit</button>
                <button onclick="deleteItem('task', ${task.id})">Delete</button>
            `;
            container.appendChild(div);
        });
    }

    function renderNotes() {
        let container = document.getElementById('my-notes');
        container.innerHTML = '';
        if (notes.length === 0) {
            container.innerHTML = '<p>note No notes yet. Add a note to get started!</p>';
            return;
        }
        notes.forEach(note => {
            let div = document.createElement('div');
            div.innerHTML = `
                ${note.title} - ${note.content}
                ${note.reminderDate ? `Reminder: ${note.reminderDate} ${note.reminderTime}` : ''}
                <button onclick="editItem('note', ${note.id})">Edit</button>
                <button onclick="deleteItem('note', ${note.id})">Delete</button>
            `;
            container.appendChild(div);
        });
    }

    function addTask() {
        let title = document.getElementById('task-title').value;
        let status = document.getElementById('task-status').value;
        if (!title) return alert('Title required');
        google.script.run.withSuccessHandler(function(id) {
            loadData();
            document.getElementById('task-title').value = '';
            currentReminderDate = '';
            currentReminderTime = '';
        }).addTask(currentUser, title, status, currentReminderDate, currentReminderTime);
    }

    function addNote() {
        let title = document.getElementById('note-title').value;
        let content = document.getElementById('note-content').value;
        if (!title || !content) return alert('Title and content required');
        google.script.run.withSuccessHandler(function(id) {
            loadData();
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            currentReminderDate = '';
            currentReminderTime = '';
        }).addNote(currentUser, title, content, currentReminderDate, currentReminderTime);
    }

    function editItem(type, id) {
        let item = type === 'task' ? tasks.find(t => t.id === id) : notes.find(n => n.id === id);
        if (!item) return;
        currentEditId = id;
        currentType = type;
        if (type === 'task') {
            document.getElementById('task-title').value = item.title;
            document.getElementById('task-status').value = item.status;
            document.getElementById('add-task-btn').innerText = 'Update Task';
            document.getElementById('add-task-btn').onclick = updateTask;
        } else {
            document.getElementById('note-title').value = item.title;
            document.getElementById('note-content').value = item.content;
            document.getElementById('add-note-btn').innerText = 'Update Note';
            document.getElementById('add-note-btn').onclick = updateNote;
        }
        currentReminderDate = item.reminderDate;
        currentReminderTime = item.reminderTime;
    }

    function updateTask() {
        let title = document.getElementById('task-title').value;
        let status = document.getElementById('task-status').value;
        google.script.run.withSuccessHandler(function() {
            loadData();
            document.getElementById('task-title').value = '';
            document.getElementById('add-task-btn').innerText = 'add Add Task';
            document.getElementById('add-task-btn').onclick = addTask;
            currentEditId = null;
            currentReminderDate = '';
            currentReminderTime = '';
        }).updateTask(currentUser, currentEditId, title, status, currentReminderDate, currentReminderTime);
    }

    function updateNote() {
        let title = document.getElementById('note-title').value;
        let content = document.getElementById('note-content').value;
        google.script.run.withSuccessHandler(function() {
            loadData();
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('add-note-btn').innerText = 'add Add Note';
            document.getElementById('add-note-btn').onclick = addNote;
            currentEditId = null;
            currentReminderDate = '';
            currentReminderTime = '';
        }).updateNote(currentUser, currentEditId, title, content, currentReminderDate, currentReminderTime);
    }

    function deleteItem(type, id) {
        if (confirm('Delete?')) {
            google.script.run.withSuccessHandler(loadData)[type === 'task' ? 'deleteTask' : 'deleteNote'](currentUser, id);
        }
    }

    function showReminderModal(type) {
        currentType = type;
        document.getElementById('reminderModal').showModal();
        document.getElementById('custom-date-time').style.display = 'none';
    }

    function closeReminderModal() {
        document.getElementById('reminderModal').close();
    }

    function setPreset(preset) {
        let now = new Date();
        let date, time;
        if (preset === 'later') {
            date = now.toISOString().split('T')[0];
            time = '18:00';
        } else if (preset === 'tomorrow') {
            now.setDate(now.getDate() + 1);
            date = now.toISOString().split('T')[0];
            time = '09:00';
        } else if (preset === 'nextWeek') {
            now.setDate(now.getDate() + (8 - now.getDay())); // Next Monday
            date = now.toISOString().split('T')[0];
            time = '09:00';
        } else if (preset === 'custom') {
            document.getElementById('custom-date-time').style.display = 'block';
            return;
        }
        currentReminderDate = date;
        currentReminderTime = time;
        confirmReminder();
    }

    function confirmReminder() {
        if (document.getElementById('custom-date-time').style.display === 'block') {
            currentReminderDate = document.getElementById('custom-date').value;
            currentReminderTime = document.getElementById('custom-time').value;
        }
        closeReminderModal();
    }

    function updateReminders() {
        let all = [...tasks, ...notes].filter(item => item.reminderDate).sort((a, b) => new Date(a.reminderDate + ' ' + a.reminderTime) - new Date(b.reminderDate + ' ' + b.reminderTime));
        let container = document.getElementById('upcoming-reminders');
        container.innerHTML = '';
        if (all.length === 0) {
            container.innerHTML = '<p>notifications_off No reminders set. Add reminders to your tasks or notes!</p>';
            return;
        }
        all.forEach(item => {
            let div = document.createElement('div');
            div.innerHTML = `${item.title || item.content} - ${item.reminderDate} ${item.reminderTime} <button onclick="deleteReminder('${item.id}', '${item.title ? 'task' : 'note'}')">Delete</button>`;
            container.appendChild(div);
        });
    }

    function deleteReminder(id, type) {
        // Set reminder to null
        if (type === 'task') {
            let task = tasks.find(t => t.id === id);
            google.script.run.withSuccessHandler(loadData).updateTask(currentUser, id, task.title, task.status, '', '');
        } else {
            let note = notes.find(n => n.id === id);
            google.script.run.withSuccessHandler(loadData).updateNote(currentUser, id, note.title, note.content, '', '');
        }
    }

    function filterCalendar() {
        let from = document.getElementById('from-date').value || new Date().toISOString().split('T')[0];
        let to = document.getElementById('to-date').value || from;
        document.getElementById('from-span').innerText = from;
        document.getElementById('to-span').innerText = to;
        let all = [...tasks, ...notes].filter(item => item.createdAt >= from && item.createdAt <= to); // Assume createdAt is date string
        let container = document.getElementById('calendar-list');
        container.innerHTML = '';
        if (all.length === 0) {
            container.innerHTML = '<p>event_available No items for selected date range.</p>';
            return;
        }
        all.forEach(item => {
            let div = document.createElement('div');
            div.innerHTML = `${item.title || item.content} (${item.title ? 'Task' : 'Note'}) - ${item.createdAt}`;
            container.appendChild(div);
        });
    }

    function quickView() {
        let date = document.getElementById('quick-date').value;
        document.getElementById('from-date').value = date;
        document.getElementById('to-date').value = date;
        filterCalendar();
    }

    function updateToday() {
        let today = new Date().toISOString().split('T')[0];
        let items = [...tasks, ...notes].filter(item => item.reminderDate === today || item.createdAt.split('T')[0] === today);
        document.getElementById('today-overview').innerHTML = items.length ? items.map(i => i.title || i.content).join('<br>') : 'No items today';
    }

    function updateStats() {
        let finished = tasks.filter(t => t.status === 'Finished').length;
        let inProcess = tasks.filter(t => t.status === 'In Process').length;
        let todo = tasks.filter(t => t.status === 'To Do').length;
        document.getElementById('quick-stats').innerHTML = `Finished: ${finished}<br>In Process: ${inProcess}<br>To Do: ${todo}<br>Notes: ${notes.length}`;
    }

    function setupNotifications() {
        if (Notification.permission !== 'granted') Notification.requestPermission();
        let all = [...tasks, ...notes].filter(item => item.reminderDate);
        all.forEach(item => {
            let reminderTime = new Date(item.reminderDate + 'T' + item.reminderTime);
            let ms = reminderTime - new Date();
            if (ms > 0) {
                setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('Reminder', {body: item.title || item.content});
                    }
                }, ms);
            }
        });
    }
</script>

</body>
</html>
